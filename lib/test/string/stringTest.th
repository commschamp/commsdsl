#include <limits>

#include "CommonTestSuite.h"

#include "commsdsl/parse/ParseStringField.h"

class StringTestSuite : public CommonTestSuite, public CxxTest::TestSuite
{
public:
    void setUp();
    void tearDown();
    void test1();
    void test2();
    void test3();
    void test4();
    void test5();
    void test6();
    void test7();
    void test8();
    void test9();
    void test10();
    void test11();
    void test12();
    void test13();
    void test14();
    void test15();
    void test16();
    void test17();
    void test18();
    void test19();
    void test20();
    void test21();
    void test22();
    void test23();
    void test24();
    void test25();
    void test26();
    void test27();
    void test28();
    void test29();
    void test30();
    void test31();
};

void StringTestSuite::setUp()
{
    CommonTestSuite::commonSetUp();
}

void StringTestSuite::tearDown()
{
    CommonTestSuite::commonTearDown();
}

void StringTestSuite::test1()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema1.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "String1");
    TS_ASSERT(field.parseDisplayName().empty());
    TS_ASSERT(field.parseDescription().empty());
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 0U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), std::numeric_limits<std::size_t>::max());

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT(stringField.parseDefaultValue().empty());
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), false);
    TS_ASSERT(!stringField.parseLengthPrefixField().parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());
}

void StringTestSuite::test2()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Warning);
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema2.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "String1");
    TS_ASSERT(field.parseDisplayName().empty());
    TS_ASSERT(field.parseDescription().empty());
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 4U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 4U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 4U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), false);
    TS_ASSERT(!stringField.parseLengthPrefixField().parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());
}

void StringTestSuite::test3()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema3.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 2U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "String1");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 1U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 256U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT(stringField.parseDefaultValue().empty());
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), true);
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());

    auto lenField = stringField.parseLengthPrefixField();
    TS_ASSERT(lenField.parseValid());
    TS_ASSERT_EQUALS(lenField.parseKind(), commsdsl::parse::ParseField::ParseKind::Int);
    TS_ASSERT_EQUALS(lenField.parseExternalRef(), "@Schema3.StrLen");
}

void StringTestSuite::test4()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema4.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "String1");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 1U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 256U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT(stringField.parseDefaultValue().empty());
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), true);
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());

    auto lenField = stringField.parseLengthPrefixField();
    TS_ASSERT(lenField.parseValid());
    TS_ASSERT_EQUALS(lenField.parseKind(), commsdsl::parse::ParseField::ParseKind::Int);
    TS_ASSERT(lenField.parseExternalRef().empty());
}

void StringTestSuite::test5()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema5.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test6()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema6.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test7()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema7.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test8()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema8.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT_EQUALS(ns.parseName(), "ns1");

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 2U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "String2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 10U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 10U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 10U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), false);
    TS_ASSERT(!stringField.parseLengthPrefixField().parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());
}

void StringTestSuite::test9()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Warning);
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema9.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT_EQUALS(ns.parseName(), "ns1");

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 2U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "String2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 4U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 4U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 4U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), false);
    TS_ASSERT(!stringField.parseLengthPrefixField().parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());
}

void StringTestSuite::test10()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema10.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test11()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema11.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT_EQUALS(ns.parseName(), "ns1");

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 3U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "String2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 1U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 256U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT_EQUALS(stringField.parseHasLengthPrefixField(), true);
    auto lenField = stringField.parseLengthPrefixField();
    TS_ASSERT(lenField.parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
    TS_ASSERT_EQUALS(lenField.parseExternalRef(), "@Schema11.ns1.Prefix");
    TS_ASSERT(stringField.parseDetachedPrefixFieldName().empty());
}

void StringTestSuite::test12()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema12.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test13()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema13.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test14()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema14.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto messages = ns.parseMessages();
    TS_ASSERT_EQUALS(messages.size(), 1U);

    auto& msg = messages.front();
    auto fields = msg.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 3U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "F3");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 0U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT(stringField.parseDefaultValue().empty());
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT(!stringField.parseHasLengthPrefixField());
    auto lenField = stringField.parseLengthPrefixField();
    TS_ASSERT_EQUALS(stringField.parseDetachedPrefixFieldName(), "F1");
    TS_ASSERT(!lenField.parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
}

void StringTestSuite::test15()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema15.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test16()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema16.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto messages = ns.parseMessages();
    TS_ASSERT_EQUALS(messages.size(), 1U);

    auto& msg = messages.front();
    auto fields = msg.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 3U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "F3");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);
    TS_ASSERT_EQUALS(field.parseMinLength(), 0U);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT(stringField.parseDefaultValue().empty());
    TS_ASSERT_EQUALS(stringField.parseFixedLength(), 0U);
    TS_ASSERT(!stringField.parseHasLengthPrefixField());
    auto lenField = stringField.parseLengthPrefixField();
    TS_ASSERT_EQUALS(stringField.parseDetachedPrefixFieldName(), "F1");
    TS_ASSERT(!lenField.parseValid());
    TS_ASSERT(!stringField.parseHasZeroTermSuffix());
}

void StringTestSuite::test17()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema17.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test18()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema18.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test19()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema19.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test20()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema20.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "S2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
}

void StringTestSuite::test21()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema21.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "S2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "^S1");
}

void StringTestSuite::test22()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema22.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 6U);

    do {
        auto& field = fields[1];
        TS_ASSERT_EQUALS(field.parseName(), "S1");
        TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

        commsdsl::parse::ParseStringField stringField(field);
        TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    } while (false);

    do {
        auto& field = fields[2];
        TS_ASSERT_EQUALS(field.parseName(), "S2");
        TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

        commsdsl::parse::ParseStringField stringField(field);
        TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
    } while (false);

    do {
        auto& field = fields[3];
        TS_ASSERT_EQUALS(field.parseName(), "S3");
        TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

        commsdsl::parse::ParseStringField stringField(field);
        TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "^S1");
    } while (false);

    do {
        auto& field = fields[4];
        TS_ASSERT_EQUALS(field.parseName(), "S4");
        TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

        commsdsl::parse::ParseStringField stringField(field);
        TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "\\\\\\^S1");
    } while (false);

    do {
        auto& field = fields[5];
        TS_ASSERT_EQUALS(field.parseName(), "S5");
        TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

        commsdsl::parse::ParseStringField stringField(field);
        TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "\\.\\\\\\^S1");
    } while (false);
}

void StringTestSuite::test23()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema23.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test24()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Warning);
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema24.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test25()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema25.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "S2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
}

void StringTestSuite::test26()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema26.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test27()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema27.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "F4");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello");
}

void StringTestSuite::test28()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema28.xml");
    TS_ASSERT(protocol);
}

void StringTestSuite::test29()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema29.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "F4");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "hello!");
}

void StringTestSuite::test30()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema30.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "F3");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::ParseKind::String);

    commsdsl::parse::ParseStringField stringField(field);
    TS_ASSERT_EQUALS(stringField.parseDefaultValue(), "bla");
}

void StringTestSuite::test31()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema31.xml");
    TS_ASSERT(protocol);
    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();

    {
        TS_ASSERT_LESS_THAN_EQUALS(1U, fields.size());

        auto& field = fields.front();
        TS_ASSERT_EQUALS(field.parseName(), "String1");

        commsdsl::parse::ParseStringField stringField(field);
        auto& validValues = stringField.parseValidValues();
        TS_ASSERT_EQUALS(validValues.size(), 3U)
        TS_ASSERT_EQUALS(validValues[0].m_value, "bla1");
        TS_ASSERT_EQUALS(validValues[0].m_sinceVersion, 1);
        TS_ASSERT_EQUALS(validValues[0].m_deprecatedSince, 4);
        TS_ASSERT_EQUALS(validValues[1].m_value, "bla2");
        TS_ASSERT_EQUALS(validValues[1].m_sinceVersion, 3);
        TS_ASSERT_EQUALS(validValues[1].m_deprecatedSince, protocol->parseNotYetDeprecated());    
        TS_ASSERT_EQUALS(validValues[2].m_value, "bla3");
        TS_ASSERT_EQUALS(validValues[2].m_sinceVersion, 0);
        TS_ASSERT_EQUALS(validValues[2].m_deprecatedSince, protocol->parseNotYetDeprecated());  
    }   

    {
        TS_ASSERT_LESS_THAN_EQUALS(2U, fields.size());

        auto& field = fields[1];
        TS_ASSERT_EQUALS(field.parseName(), "String2");

        commsdsl::parse::ParseStringField stringField(field);
        auto& validValues = stringField.parseValidValues();
        TS_ASSERT_EQUALS(validValues.size(), 4U)
        TS_ASSERT_EQUALS(validValues[0].m_value, "bla1");
        TS_ASSERT_EQUALS(validValues[0].m_sinceVersion, 1);
        TS_ASSERT_EQUALS(validValues[0].m_deprecatedSince, 4);
        TS_ASSERT_EQUALS(validValues[1].m_value, "bla2");
        TS_ASSERT_EQUALS(validValues[1].m_sinceVersion, 3);
        TS_ASSERT_EQUALS(validValues[1].m_deprecatedSince, protocol->parseNotYetDeprecated());    
        TS_ASSERT_EQUALS(validValues[2].m_value, "bla3");
        TS_ASSERT_EQUALS(validValues[2].m_sinceVersion, 0);
        TS_ASSERT_EQUALS(validValues[2].m_deprecatedSince, protocol->parseNotYetDeprecated());  
        TS_ASSERT_EQUALS(validValues[3].m_value, "bla4");
        TS_ASSERT_EQUALS(validValues[3].m_sinceVersion, 0);
        TS_ASSERT_EQUALS(validValues[3].m_deprecatedSince, protocol->parseNotYetDeprecated());          
    }        
}
