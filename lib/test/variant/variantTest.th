#include <limits>

#include "CommonTestSuite.h"

#include "commsdsl/parse/ParseBundleField.h"
#include "commsdsl/parse/ParseIntField.h"
#include "commsdsl/parse/ParseVariantField.h"

class BundleTestSuite : public CommonTestSuite, public CxxTest::TestSuite
{
public:
    void setUp();
    void tearDown();
    void test1();
    void test2();
    void test3();
    void test4();
    void test5();
    void test6();
    void test7();
};

void BundleTestSuite::setUp()
{
    CommonTestSuite::commonSetUp();
}

void BundleTestSuite::tearDown()
{
    CommonTestSuite::commonTearDown();
}

void BundleTestSuite::test1()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema1.xml");
    TS_ASSERT(protocol);

    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "Variant1");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::Kind::Variant);
    TS_ASSERT_EQUALS(field.parseMinLength(), 0U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 5U);
    TS_ASSERT_EQUALS(field.parseBitLength(), 0U);

    commsdsl::parse::ParseVariantField variantField(field);
    auto members = variantField.parseMembers();
    TS_ASSERT_EQUALS(members.size(), 2U);
    auto& mem1 = members[0];
    auto& mem2 = members[1];
    TS_ASSERT_EQUALS(mem1.parseKind(), commsdsl::parse::ParseField::Kind::Bundle);
    TS_ASSERT_EQUALS(mem2.parseKind(), commsdsl::parse::ParseField::Kind::Bundle);
    TS_ASSERT_LESS_THAN_EQUALS(members.size(), variantField.parseDefaultMemberIdx());
}

void BundleTestSuite::test2()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema2.xml");
    TS_ASSERT(protocol);

    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "Variant1");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::Kind::Variant);
    TS_ASSERT_EQUALS(field.parseMinLength(), 0U);
    TS_ASSERT_EQUALS(field.parseMaxLength(), 5U);
    TS_ASSERT_EQUALS(field.parseBitLength(), 0U);

    commsdsl::parse::ParseVariantField variantField(field);
    auto members = variantField.parseMembers();
    TS_ASSERT_EQUALS(members.size(), 2U);
    auto& mem1 = members[0];
    auto& mem2 = members[1];
    TS_ASSERT_EQUALS(mem1.parseKind(), commsdsl::parse::ParseField::Kind::Bundle);
    TS_ASSERT_EQUALS(mem2.parseKind(), commsdsl::parse::ParseField::Kind::Bundle);
    TS_ASSERT_EQUALS(variantField.parseDefaultMemberIdx(), 0U);
}

void BundleTestSuite::test3()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema3.xml");
    TS_ASSERT(protocol);

    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 1U);

    auto& field = fields.front();
    TS_ASSERT_EQUALS(field.parseName(), "Variant1");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::Kind::Variant);

    commsdsl::parse::ParseVariantField variantField(field);
    auto members = variantField.parseMembers();
    TS_ASSERT_EQUALS(members.size(), 2U);
    TS_ASSERT_EQUALS(variantField.parseDefaultMemberIdx(), 1U);
}

void BundleTestSuite::test4()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema4.xml");
    TS_ASSERT(protocol);

    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 2U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "Variant2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::Kind::Variant);

    commsdsl::parse::ParseVariantField variantField(field);
    auto members = variantField.parseMembers();
    TS_ASSERT_EQUALS(members.size(), 2U);
    TS_ASSERT_LESS_THAN_EQUALS(members.size(), variantField.parseDefaultMemberIdx());
}

void BundleTestSuite::test5()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema5.xml");
    TS_ASSERT(protocol);
}

void BundleTestSuite::test6()
{
    m_status.m_expErrors.push_back(commsdsl::parse::ParseErrorLevel_Error);
    m_status.m_expValidateResult = false;
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema6.xml");
    TS_ASSERT(protocol);
}

void BundleTestSuite::test7()
{
    auto protocol = prepareProtocol(SCHEMAS_DIR "/Schema7.xml");
    TS_ASSERT(protocol);

    auto namespaces = protocol->parseLastParsedSchema().parseNamespaces();
    TS_ASSERT_EQUALS(namespaces.size(), 1U);

    auto& ns = namespaces.front();
    TS_ASSERT(ns.parseName().empty());

    auto fields = ns.parseFields();
    TS_ASSERT_EQUALS(fields.size(), 3U);

    auto& field = fields.back();
    TS_ASSERT_EQUALS(field.parseName(), "Variant2");
    TS_ASSERT_EQUALS(field.parseKind(), commsdsl::parse::ParseField::Kind::Variant);

    commsdsl::parse::ParseVariantField variantField(field);
    auto members = variantField.parseMembers();
    TS_ASSERT_EQUALS(members.size(), 3U);
    TS_ASSERT_EQUALS(variantField.parseDefaultMemberIdx(), 2);

    auto& p2 = members[1];
    TS_ASSERT_EQUALS(p2.parseKind(), commsdsl::parse::ParseField::Kind::Bundle);

    commsdsl::parse::ParseBundleField bundleP2Field(p2);
    auto p2Members = bundleP2Field.parseMembers();
    TS_ASSERT_EQUALS(p2Members.size(), 2U);

    auto& p2Key = p2Members[0];
    TS_ASSERT_EQUALS(p2Key.parseKind(), commsdsl::parse::ParseField::Kind::Int);
    TS_ASSERT(p2Key.parseIsFixedValue());    
    
    auto& p2Val = p2Members[1];
    TS_ASSERT_EQUALS(p2Val.parseKind(), commsdsl::parse::ParseField::Kind::Int);

    commsdsl::parse::ParseIntField p2ValField(p2Val);
    TS_ASSERT_EQUALS(p2ValField.parseType(), commsdsl::parse::ParseIntField::Type::Uint16);
}
