#include "cxxtest/TestSuite.h"

#include "cc_c/test1/Message.h"
#include "cc_c/test1/MsgHandler.h"
#include "cc_c/test1/frame/Frame.h"
#include "cc_c/test1/message/Msg1.h"
#include "cc_c/test1/message/Msg2.h"

#include <cstdint>
#include <cstddef>
#include <memory>

class TestSuite : public CxxTest::TestSuite
{
public:
    void test1();

private:
    struct Deleter
    {
        void operator()(test1_frame_Frame* ptr)
        {
            test1_frame_Frame_free(ptr);
        }
    };

    struct Handler
    {
        unsigned m_msg1Count = 0U;
        unsigned m_msg2Count = 0U;
        unsigned m_interfaceCount = 0U;

        static void handle_test1_message_Msg1(test1_message_Msg1* msg, void* userData)
        {
            static_cast<void>(msg);
            ++(asHandler(userData)->m_msg1Count);
        }

        static void handle_test1_message_Msg2(test1_message_Msg2* msg, void* userData)
        {
            static_cast<void>(msg);
            ++(asHandler(userData)->m_msg2Count);
        }

        static void handle_test1_Message(test1_Message* msg, void* userData)
        {
            static_cast<void>(msg);
            ++(asHandler(userData)->m_interfaceCount);
        }
        
    private:
        static Handler* asHandler(void* userData)
        {
            return reinterpret_cast<Handler*>(userData);
        }
    };

    using FramePtr = std::unique_ptr<test1_frame_Frame, Deleter>;    
};

void TestSuite::test1()
{
    static const std::uint8_t Buf[] = {1, 0x1, 0x2, 0x3, 0x4};
    static const std::size_t BufSize = std::extent<decltype(Buf)>::value; 
    
    FramePtr frame(test1_frame_Frame_alloc());

    auto handler = test1_MsgHandler();
    handler.handle_test1_message_Msg1 = &Handler::handle_test1_message_Msg1;
    handler.handle_test1_message_Msg2 = &Handler::handle_test1_message_Msg2;
    handler.handle_test1_Message = &Handler::handle_test1_Message;

    Handler testHandler;
    auto consumed = test1_frame_Frame_processInputData(frame.get(), Buf, BufSize, &handler, &testHandler);
    TS_ASSERT_EQUALS(consumed, BufSize);
    // TS_ASSERT_EQUALS(testHandler.m_msg1Count, 1U);
    // TS_ASSERT_EQUALS(testHandler.m_msg2Count, 0U);
    // TS_ASSERT_EQUALS(testHandler.m_interfaceCount, 0U);
}
